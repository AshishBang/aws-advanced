######################################################################################
#  Description
######################################################################################

Description: >
    This is a simple hello world ecs example
#by wolfgang unger 3.2018
######################################################################################
#  Parameters
######################################################################################

Parameters: 

    EnvironmentName:
        Description: An environment name that will be prefixed to resource names
        Type: String
        Default: ungerwHelloWorld-bridge

    ParentVPCStack:
        Description: Please enter the Parent VPC Stack (do not change)
        Type: String
        Default: UngerwVPC

    ParentECSStack:
        Description: Please enter the Parent ECS Stack (do not change)
        Type: String
        Default: UngerwECS

    DesiredCount: 
        Description: How many instances of this task should we run across our cluster?
        Type: Number
        Default: 2

    MaxCount:
        Description: Maximum number of instances of this task we can run across our cluster
        Type: Number
        Default: 3

######################################################################################
#  Metadata
######################################################################################
Metadata:
  AWS::CloudFormation::Interface: 
    ParameterGroups:
      - 
        Label: 
          default: "Base Service Configuration"
        Parameters: 
          - EnvironmentName
          - ParentVPCStack
          - ParentECSStack
      - 
        Label: 
          default: "Scaling Configuration"
        Parameters: 
          - DesiredCount
          - MaxCount

######################################################################################
#  Resources
######################################################################################

Resources:

    ######################################################################################
    #  ECS Service and Task Definition
    ######################################################################################

    Service: 
        Type: AWS::ECS::Service
        DependsOn: LoadBalancerListener
        Properties: 
            Cluster:
                'Fn::ImportValue': !Sub '${ParentECSStack}-Cluster'
            Role: !Ref ServiceRole
            DesiredCount: !Ref DesiredCount
            TaskDefinition: !Ref TaskDefinition
            LoadBalancers: 
                - ContainerName: !Sub '${EnvironmentName}'
                  ContainerPort: 80
                  TargetGroupArn: !Ref TargetGroup

    TaskDefinition:
        Type: AWS::ECS::TaskDefinition
        Properties:
            Family: !Sub '${EnvironmentName}'
            NetworkMode: bridge
            ContainerDefinitions:
                - Name: !Sub '${EnvironmentName}'
                  Essential: true
                  Image: strm/helloworld-http
                  Memory: 128
                  PortMappings:
                    - ContainerPort: 80
                  LogConfiguration:
                    LogDriver: awslogs
                    Options:
                        awslogs-group: !Ref AWS::StackName
                        awslogs-region: !Ref AWS::Region

    CloudWatchLogsGroup:
        Type: AWS::Logs::LogGroup
        Properties: 
            LogGroupName: !Ref AWS::StackName
            RetentionInDays: 1  

    ######################################################################################
    #  Loadbalancing
    ######################################################################################

    LoadBalancer:
        Type: AWS::ElasticLoadBalancingV2::LoadBalancer
        Properties:
            Name: !Sub LB-${AWS::StackName}
            Type: application
            Scheme: internet-facing
            Subnets: !Split
              - ','
              - 'Fn::ImportValue':
                    !Sub '${ParentVPCStack}-PublicSubnets' # <- Change for private or public services
            SecurityGroups: 
                - 'Fn::ImportValue': !Sub '${ParentECSStack}-LoadBalancerSecurityGroup'
            Tags: 
                - Key: Name
                  Value: !Sub LB-${AWS::StackName}

    LoadBalancerListener:
        Type: AWS::ElasticLoadBalancingV2::Listener
        Properties:
            LoadBalancerArn: !Ref LoadBalancer
            Port: 80
            Protocol: HTTP 
            DefaultActions: 
                - Type: forward
                  TargetGroupArn: !Ref TargetGroup

    TargetGroup:
        Type: AWS::ElasticLoadBalancingV2::TargetGroup
        Properties:
            VpcId:
                'Fn::ImportValue': !Sub '${ParentVPCStack}-VPC'
            Port: 80
            Protocol: HTTP
            Matcher: 
                HttpCode: 200-299
            HealthCheckIntervalSeconds: 10
            HealthCheckPath: /
            HealthCheckProtocol: HTTP
            HealthCheckTimeoutSeconds: 5
            HealthyThresholdCount: 2
            #TargetType: ip
    
    ######################################################################################
    #  IAM Roles
    ######################################################################################
    # This IAM Role grants the service access to register/unregister with the 
    # Application Load Balancer (ALB). It is based on the default documented here:
    # http://docs.aws.amazon.com/AmazonECS/latest/developerguide/service_IAM_role.html

   
    ServiceRole:
     Type: 'AWS::IAM::Role'
     Properties:
      RoleName: !Sub '${EnvironmentName}-ServiceRole'
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ecs.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /
      Policies:
        - PolicyName: AmazonEC2ContainerServiceRole
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - 'ec2:AuthorizeSecurityGroupIngress'
                  - 'ec2:Describe*'
                  - 'elasticloadbalancing:DeregisterInstancesFromLoadBalancer'
                  - 'elasticloadbalancing:DeregisterTargets'
                  - 'elasticloadbalancing:Describe*'
                  - 'elasticloadbalancing:RegisterInstancesWithLoadBalancer'
                  - 'elasticloadbalancing:RegisterTargets'
                Resource: '*'   

    ######################################################################################
    #  Autoscaling
    ######################################################################################




 

#####################################################################################
#  Outputs
######################################################################################

Outputs:

    LoadBalancer:
        Description: A reference to the Application Load Balancer
        Value: !Ref LoadBalancer
        Export:
            Name: !Sub LB-${AWS::StackName}

    LoadBalancerUrl:
        Description: The URL of the ALB
        Value: !GetAtt LoadBalancer.DNSName
        Export:
            Name: !Sub LB-URL-${AWS::StackName}

    Listener:
        Description: A reference to a port 80 listener
        Value: !Ref LoadBalancerListener  
        Export:
            Name: !Sub LB-Listener-${AWS::StackName}
    